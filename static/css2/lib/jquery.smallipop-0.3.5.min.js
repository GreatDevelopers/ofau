/*!
Smallipop (01/21/2013)
Copyright (c) 2011-2013 Small Improvements (http://www.small-improvements.com)

Licensed under the MIT (http://www.opensource.org/licenses/mit-license.php) license.

@author Sebastian Helzle (sebastian@helzle.net)
*/
(function(b){var a;b.smallipop=a={version:"0.3.4",defaults:{autoscrollPadding:200,contentAnimationSpeed:150,cssAnimations:{enabled:false,show:"animated fadeIn",hide:"animated fadeOut"},funcEase:"easeInOutQuad",handleInputs:true,hideDelay:500,hideTrigger:false,hideOnPopupClick:true,hideOnTriggerClick:true,infoClass:"smallipopHint",invertAnimation:false,popupOffset:31,popupYOffset:0,popupDistance:20,popupDelay:100,popupAnimationSpeed:200,preferredPosition:"top",referencedSelector:null,theme:"default",touchSupport:true,triggerAnimationSpeed:150,triggerOnClick:false,onAfterHide:null,onAfterShow:null,onBeforeHide:null,onBeforeShow:null,onTourClose:null,onTourNext:null,onTourPrev:null,windowPadding:30},currentTour:null,lastId:1,nextInstanceId:1,lastScrollCheck:0,labels:{prev:"Back",next:"Next",close:"Close",of:"of"},instances:{},scrollTimer:null,templates:{popup:'        <div class="smallipop-instance">          <div class="sipContent"/>          <div class="sipArrowBorder"/>          <div class="sipArrow"/>        </div>'},tours:{},_hideSmallipop:function(p){var s,i,m,d,g,c,q,o,h,j,r,f,n,l,k;o=(p!=null?p.target:void 0)?b(p.target):p;n=a.instances;k=[];for(c in n){d=n[c];g=d.data();if(!(q=g.shown)){continue}if(g.isTour&&!d.is(o)){continue}h=b(".smallipop"+q);j=((l=h.data("smallipop"))!=null?l.options:void 0)||a.defaults;m=!j.hideOnTriggerClick&&o.is(h);i=!j.hideOnPopupClick&&d.find(o).length;if(o&&h.length&&(p!=null?p.type:void 0)==="click"&&(m||i)){continue}if(q&&j.hideTrigger){h.stop(true).fadeTo(j.triggerAnimationSpeed,1)}d.data({hideDelayTimer:null,beingShown:false});if(j.cssAnimations.enabled){d.removeClass(j.cssAnimations.show).addClass(j.cssAnimations.hide).data("shown","");if(j.onAfterHide){k.push(window.setTimeout(j.onAfterHide,j.popupAnimationSpeed))}else{k.push(void 0)}}else{s=j.invertAnimation?-1:1;r=g.xDistance*s;f=g.yDistance*s;k.push(d.stop(true).animate({top:"-="+r+"px",left:"+="+f+"px",opacity:0},j.popupAnimationSpeed,j.funcEase,function(){var e;e=b(this);if(!e.data("beingShown")){e.css("display","none").data("shown","")}return typeof j.onAfterHide==="function"?j.onAfterHide():void 0}))}}return k},_showSmallipop:function(f){var c,d;c=b(this).data("smallipop");if(c.popupInstance.data("shown")!==c.id&&((d=!c.type)==="checkbox"||d==="radio")){if(f!=null){f.preventDefault()}}return a._triggerMouseover.call(this)},_onTouchDevice:function(){return typeof Modernizr!=="undefined"&&Modernizr!==null?Modernizr.touch:void 0},_killTimers:function(c){clearTimeout(c.data("hideDelayTimer"));return clearTimeout(c.data("showDelayTimer"))},_refreshPosition:function(){var E,q,n,h,i,c,D,o,B,p,l,m,k,A,s,C,H,F,I,g,x,z,w,j,e,v,y,u,G,r,t,f,d;t=a.instances;d=[];for(A in t){c=t[A];o=c.data();z=o.shown;if(!z){continue}w=b(".smallipop"+z);i=w.data("smallipop").options;c.removeClass(function(J,K){return((K!=null?K.match(/sip\w+/g):void 0)||[]).join(" ")});c.addClass(i.theme);j=b(window);u=G=i.popupDistance;r=i.popupYOffset;q=c.data("position")==="fixed";n=w.offset();k=c.outerHeight();H=c.outerWidth();D=H/2;v=j.width();e=j.height();y=i.windowPadding;g=w.outerWidth();I=w.outerHeight();x=n.top-j.scrollTop();s=n.left+g/2;C=n.top-k+r;F=k+i.popupDistance-r;m=x-F;B=e-x-I-F;p=n.left-H-i.popupOffset;l=v-n.left-g-H;if((f=i.preferredPosition)==="left"||f==="right"){u=0;C+=I/2+k/2;if((i.preferredPosition==="left"&&p>y)||l<y){c.addClass("sipPositionedLeft");s=n.left-H-i.popupOffset;G=-G}else{c.addClass("sipPositionedRight");s=n.left+g+i.popupOffset}}else{G=0;if(s+D>v-y){s-=D*2-i.popupOffset;c.addClass("sipAlignLeft")}else{if(s-D<y){s-=i.popupOffset;c.addClass("sipAlignRight")}else{s-=D}}if((i.preferredPosition==="bottom"&&B>y)||m<y){C+=k+I-2*r;u=-u;r=0;c.addClass("sipAlignBottom")}}if(i.hideTrigger){w.stop(true).fadeTo(i.triggerAnimationSpeed,0)}h=0;E=o.beingShown&&!i.cssAnimations.enabled;if(!E){C-=u;s+=G;u=0;G=0;h=1}if(q){s-=j.scrollLeft();C-=j.scrollTop()}c.data({xDistance:u,yDistance:G}).css({top:C,left:s,display:"block",opacity:h});d.push(a._fadeInPopup(c,{top:"-="+u+"px",left:"+="+G+"px",opacity:1}))}return d},_fadeInPopup:function(d,c){var e,f;e=((f=a._getTrigger(d.data("shown")).data("smallipop"))!=null?f.options:void 0)||a.defaults;if(e.cssAnimations.enabled){d.addClass(e.cssAnimations.show);return window.setTimeout(function(){return a._fadeInPopupFinished(d,e)},e.popupAnimationSpeed)}else{return d.stop(true).animate(c,e.popupAnimationSpeed,e.funcEase,function(){return a._fadeInPopupFinished(d,e)})}},_fadeInPopupFinished:function(d,e){var c;c=d.data();if(c.beingShown){d.data("beingShown",false);return typeof e.onAfterShow==="function"?e.onAfterShow(a._getTrigger(c.shown)):void 0}},_getTrigger:function(c){return b(".smallipop"+c)},_showPopup:function(e,h){var i,g,f,d,k,j,c;if(h==null){h=""}c=e.data("smallipop");d=c.popupInstance;if(!d.data("triggerHovered")){return}j=d.data("shown");if(j){g=a._getTrigger(j);if(g.length){f=g.data("smallipop").options||a.defaults;if(f.hideTrigger){g.stop(true).fadeTo(f.fadeSpeed,1)}}}k=h||c.hint;if(c.options.referencedContent&&!h){k=b(c.options.referencedContent).html()||k}d.data({beingShown:true,shown:c.id}).find(".sipContent").html(k);d.data("position","").css("position","absolute");i=e;while(i.length&&i[0].nodeName!=="HTML"){if(i.css("position")==="fixed"){d.data("position","fixed").css("position","fixed");break}i=i.parent()}if(c.id!==j){d.attr("class","smallipop-instance")}return a._refreshPosition()},_triggerMouseover:function(){var h,c,e,d,g,f;d=c=b(this);h=d.hasClass("sipInitialized");if(!h){d=a._getTrigger(c.data("shown"))}if(!d.length){return}g=d.data("smallipop");c=g.popupInstance.data((h?"triggerHovered":"hovered"),true);a._killTimers(c);e=c.data("shown");if(e!==g.id||c.css("opacity")===0){if(typeof(f=g.options).onBeforeShow==="function"){f.onBeforeShow(d)}return c.data("showDelayTimer",setTimeout(function(){return a._showPopup(d)},g.options.popupDelay))}},_triggerMouseout:function(){var h,d,c,e,g,f;e=d=b(this);h=e.hasClass("sipInitialized");if(!h){e=a._getTrigger(d.data("shown"))}if(!e.length){return}g=e.data("smallipop");d=g.popupInstance.data((h?"triggerHovered":"hovered"),false);a._killTimers(d);c=d.data();if(!(c.hovered||c.triggerHovered)){if(typeof(f=g.options).onBeforeHide==="function"){f.onBeforeHide(e)}return d.data("hideDelayTimer",setTimeout(function(){return a._hideSmallipop(d)},g.options.hideDelay))}},_onWindowScroll:function(c){clearTimeout(a.scrollTimer);return a.scrollTimer=setTimeout(a._refreshPosition,250)},setContent:function(e,g){var d,c,f;if(!(e!=null?e.length:void 0)){return}f=e.data("smallipop");d=f.tourTitle;if(d){c=f.popupInstance.find(".smallipop-tour-content")}else{c=f.popupInstance.find(".sipContent")}if(c.html()!==g){return c.stop(true).fadeTo(f.options.contentAnimationSpeed,0,function(){b(this).html(g).fadeTo(f.options.contentAnimationSpeed,1);return a._refreshPosition()})}},_runTour:function(d){var g,e,c,f,j,h;f=d.data("smallipop");c=f!=null?f.tourTitle:void 0;if(!(c&&a.tours[c])){return}a.tours[c].sort(function(k,i){return k.index-i.index});a.currentTour=c;g=a.tours[c];for(e=j=0,h=g.length-1;0<=h?j<=h:j>=h;e=0<=h?++j:--j){if(g[e].id===f.id){return a._tourShow(c,e)}}},_tourShow:function(i,f){var d,g,h,k,j,e,c;h=a.tours[i];if(!h){return}e=h[f].trigger;c=e.data("smallipop");j=f>0?'<a href="#" class="smallipop-tour-prev">'+a.labels.prev+"</a>":"";k=f<h.length-1?'<a href="#" class="smallipop-tour-next">'+a.labels.next+"</a>":"";d=f===h.length-1?'<a href="#" class="smallipop-tour-close">'+a.labels.close+"</a>":"";g='        <div class="smallipop-tour-content">'+c.hint+'</div>        <div class="smallipop-tour-footer">          <div class="smallipop-tour-progress">            '+(f+1)+" "+a.labels.of+" "+h.length+"          </div>          "+j+"          "+k+"          "+d+'          <br style="clear:both;"/>        </div>';a._killTimers(c.popupInstance);c.popupInstance.data("triggerHovered",true);return a._showWhenVisible(e,g)},_showWhenVisible:function(c,e){var g,d,f,h;d=c.offset().top;g=d-b(document).scrollTop();h=b(window).height();f=c.data("smallipop").options;if(g<f.autoscrollPadding||g>h-f.autoscrollPadding){return b("html, body").animate({scrollTop:d-h/2},800,"swing",function(){return a._showPopup(c,e)})}else{return a._showPopup(c,e)}},_tourNext:function(j){var l,h,c,k,m,f,g,d;if(j!=null){j.preventDefault()}l=a.tours[a.currentTour];if(!l){return}c=l[0].popupInstance;k=c.data("shown")||l[0].id;for(h=f=0,g=l.length-2;0<=g?f<=g:f>=g;h=0<=g?++f:--f){if(!(l[h].id===k)){continue}if((d=l[h].trigger.data("smallipop"))!=null){if(typeof(m=d.options).onTourNext==="function"){m.onTourNext(l[h+1].trigger)}}return a._tourShow(a.currentTour,h+1)}},_tourPrev:function(j){var l,h,c,k,m,f,g,d;if(j!=null){j.preventDefault()}l=a.tours[a.currentTour];if(!l){return}c=l[0].popupInstance;k=c.data("shown")||l[0].id;for(h=f=1,g=l.length-1;1<=g?f<=g:f>=g;h=1<=g?++f:--f){if(!(l[h].id===k)){continue}if((d=l[h].trigger.data("smallipop"))!=null){if(typeof(m=d.options).onTourPrev==="function"){m.onTourPrev(l[h-1].trigger)}}return a._tourShow(a.currentTour,h-1)}},_tourClose:function(g){var c,d,f;if(g!=null){g.preventDefault()}c=b(g.target).closest(".smallipop-instance");if((f=a._getTrigger(c.data("shown")).data("smallipop"))!=null){if(typeof(d=f.options).onTourClose==="function"){d.onTourClose()}}return a._hideSmallipop(c)},_destroy:function(c){return c.each(function(){var e,d;d=b(this);e=d.data("smallipop");if(e){return d.unbind(".smallipop").data("smallipop",{}).removeClass("smallipop sipInitialized smallipop"+e.id+" "+e.options.theme)}})},_onWindowKeyUp:function(j){var f,g,h,i,c,d;h=(i=j!=null?j.target.tagName.toLowerCase():void 0)==="input"||i==="textarea";switch(j.which){case 27:c=a.instances;d=[];for(g in c){f=c[g];d.push(a._hideSmallipop(f))}return d;break;case 37:if(!h){return a._tourPrev()}break;case 39:if(!h){return a._tourNext()}}},_getInstance:function(e,d){var c;if(e==null){e="default"}if(d==null){d=false}if(a.instances[e]){return a.instances[e]}c=b(a.templates.popup).css("opacity",0).attr("id","smallipop"+(a.nextInstanceId++)).addClass("smallipop-instance").data({xDistance:0,yDistance:0,isTour:d}).bind({"mouseover.smallipop":a._triggerMouseover,"mouseout.smallipop":a._triggerMouseout});b("body").append(c);if(d){c.delegate(".smallipop-tour-prev","click.smallipop",a._tourPrev).delegate(".smallipop-tour-next","click.smallipop",a._tourNext).delegate(".smallipop-tour-close","click.smallipop",a._tourClose)}else{c.delegate("a","click.smallipop",a._hideSmallipop)}if(a.nextInstanceId===2){b(document).bind("click.smallipop touchend.smallipop",a._hideSmallipop);b(window).bind({"resize.smallipop":a._refreshPosition,"scroll.smallipop":a._onWindowScroll,keyup:a._onWindowKeyUp})}return a.instances[e]=c}};if(!b.easing.easeInOutQuad){b.easing.easeInOutQuad=function(f,g,e,i,h){if((g/=h/2)<1){return i/2*g*g+e}else{return -i/2*((--g)*(g-2)-1)+e}}}return b.fn.smallipop=function(d,e){var c;if(d==null){d={}}if(e==null){e=""}if(typeof d==="string"){switch(d.toLowerCase()){case"show":a._showSmallipop.call(this.first().get(0));break;case"hide":a._hideSmallipop(this.first().get(0));break;case"destroy":a._destroy(this);break;case"tour":a._runTour(this.first());break;case"update":a.setContent(this.first(),e)}return this}d=b.extend({},a.defaults,d);if((typeof Modernizr!=="undefined"&&Modernizr!==null?Modernizr.cssanimations:void 0)===false){d.cssAnimations.enabled=false}c=a._getInstance();return this.each(function(){var l,i,r,n,g,s,h,k,f,o,j,m,p,q;s=b(this);h=s[0].tagName.toLowerCase();p=s.attr("type");f=s.data();r=e||s.find("."+d.infoClass).html()||s.attr("title");if(r&&!s.hasClass("sipInitialized")){i=a.lastId++;o={};m=c;j=b.extend(true,{},d);for(n in f){q=f[n];if(!(n.indexOf("smallipop")>=0)){continue}g=n.replace("smallipop","");g=g.substr(0,1).toLowerCase()+g.substr(1);j[g]=q}l=j.handleInputs&&(h==="input"||h==="select"||h==="textarea");if(l){j.hideOnTriggerClick=false;o["focus.smallipop"]=a._triggerMouseover;o["blur.smallipop"]=a._triggerMouseout}else{o["mouseout.smallipop"]=a._triggerMouseout}if(j.triggerOnClick||(j.touchSupport&&a._onTouchDevice())){o["click.smallipop"]=a._showSmallipop}else{o["click.smallipop"]=a._triggerMouseout;o["mouseover.smallipop"]=a._triggerMouseover}if(j.tourIndex){k=j.tourTitle||"defaultTour";o={};j.hideOnTriggerClick=false;j.hideOnPopupClick=false;m=a._getInstance(k,true);if(!a.tours[k]){a.tours[k]=[]}a.tours[k].push({index:j.tourIndex||0,id:i,trigger:s,popupInstance:m})}s.addClass("sipInitialized smallipop"+i).attr("title","").data("smallipop",{id:i,hint:r,options:j,tagName:h,type:p,tourTitle:k,popupInstance:m}).bind(o);if(!j.hideOnTriggerClick){return s.delegate("a","click.smallipop",a._hideSmallipop)}}})}})(jQuery);